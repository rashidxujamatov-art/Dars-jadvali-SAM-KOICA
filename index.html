import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Trash2, Calendar, Users, BookOpen, UserCheck, 
  Settings, Download, AlertTriangle, CheckCircle2, 
  ChevronRight, ChevronLeft, Info, Lock
} from 'lucide-react';

// --- Boshlang'ich Ma'lumotlar ---
const INITIAL_DATA = {
  groups: [
    { id: 'g1', name: '711-20', semester: 4 },
    { id: 'g2', name: '712-20', semester: 4 }
  ],
  teachers: [
    { id: 't1', firstName: 'Aziz', lastName: 'Rahimov', maxDaily: 8, maxWeekly: 40 },
    { id: 't2', firstName: 'Malika', lastName: 'Sultonova', maxDaily: 6, maxWeekly: 30 }
  ],
  subjects: [
    { id: 's1', name: 'Algoritmlar', type: 'Nazariy', hours: 32, priority: 8, color: '#3b82f6' },
    { id: 's2', name: 'MaÊ¼lumotlar Ombori', type: 'Amaliy', hours: 48, priority: 10, color: '#10b981' }
  ],
  holidays: ['2024-03-21', '2024-09-01']
};

const DAYS = ['Dushanba', 'Seshanba', 'Chorshanba', 'Payshanba', 'Juma', 'Shanba'];
const SLOTS = [
  { id: 1, time: '08:30 - 09:50' },
  { id: 2, time: '10:00 - 11:20' },
  { id: 3, time: '11:30 - 12:50' },
  { id: 4, time: '13:30 - 14:50' },
];

const App = () => {
  const [view, setView] = useState('user'); // 'user' yoki 'admin'
  const [activeTab, setActiveTab] = useState('schedule');
  const [groups, setGroups] = useState(INITIAL_DATA.groups);
  const [teachers, setTeachers] = useState(INITIAL_DATA.teachers);
  const [subjects, setSubjects] = useState(INITIAL_DATA.subjects);
  const [schedule, setSchedule] = useState([]);
  const [selectedGroup, setSelectedGroup] = useState(INITIAL_DATA.groups[0].id);
  const [isGenerating, setIsGenerating] = useState(false);

  // --- Algoritm: Jadval yaratish ---
  const generateSchedule = () => {
    setIsGenerating(true);
    setTimeout(() => {
      const newSchedule = [];
      const teacherWorkload = {}; // { teacherId: { day: hours } }

      groups.forEach(group => {
        let currentDay = 0;
        let currentSlot = 1;

        // Amaliy fanlarni birinchi joylashtirish (Prioritet bo'yicha)
        const sortedSubjects = [...subjects].sort((a, b) => b.priority - a.priority);

        sortedSubjects.forEach(subject => {
          const teacher = teachers[Math.floor(Math.random() * teachers.length)];
          const lessonCount = subject.type === 'Amaliy' ? 3 : 1; // Amaliy 3 juftlik, Nazariy 1

          // Bo'sh joy qidirish va konfliktlarni tekshirish logic (Soddalashtirilgan Greedy)
          if (currentSlot + lessonCount <= SLOTS.length + 1) {
            for (let i = 0; i < lessonCount; i++) {
              newSchedule.push({
                id: Math.random().toString(36).substr(2, 9),
                groupId: group.id,
                subjectId: subject.id,
                teacherId: teacher.id,
                day: DAYS[currentDay],
                slot: currentSlot + i,
                type: subject.type
              });
            }
            currentSlot += lessonCount;
            if (currentSlot > SLOTS.length) {
              currentSlot = 1;
              currentDay++;
            }
          }
        });
      });

      setSchedule(newSchedule);
      setIsGenerating(false);
    }, 1000);
  };

  // --- PDF Export Simulyatsiyasi ---
  const handleExportPDF = () => {
    const printContent = document.getElementById('printable-schedule');
    const originalContents = document.body.innerHTML;
    window.print();
  };

  const getLesson = (day, slotId, groupId) => {
    return schedule.find(s => s.day === day && s.slot === slotId && s.groupId === groupId);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      {/* Navbar */}
      <nav className="bg-white border-b sticky top-0 z-50 px-6 py-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="bg-blue-600 p-2 rounded-lg">
            <Calendar className="text-white" size={24} />
          </div>
          <h1 className="text-xl font-bold tracking-tight">Gema Schedule <span className="text-blue-600">PRO</span></h1>
        </div>

        <div className="flex items-center gap-4">
          <button 
            onClick={() => setView(view === 'user' ? 'admin' : 'user')}
            className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all ${
              view === 'admin' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-700'
            }`}
          >
            {view === 'admin' ? <Settings size={16} /> : <UserCheck size={16} />}
            {view === 'admin' ? "Admin Panel" : "Foydalanuvchi"}
          </button>
          
          {view === 'admin' && (
            <button 
              onClick={generateSchedule}
              disabled={isGenerating}
              className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full text-sm font-semibold shadow-lg shadow-blue-200 disabled:opacity-50 transition-all"
            >
              {isGenerating ? "Hisoblanmoqda..." : "Avto-Generator"}
            </button>
          )}
          
          <button 
            onClick={handleExportPDF}
            className="flex items-center gap-2 border border-slate-200 hover:bg-slate-50 px-4 py-2 rounded-full text-sm font-medium"
          >
            <Download size={16} /> Export PDF
          </button>
        </div>
      </nav>

      <main className="p-6 max-w-[1600px] mx-auto grid grid-cols-12 gap-6">
        
        {/* Sidebar Controls */}
        <div className="col-span-12 lg:col-span-3 space-y-6">
          <div className="bg-white p-5 rounded-2xl border shadow-sm">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Filtrlash</h3>
            <label className="block text-sm font-medium mb-2">Guruhni tanlang</label>
            <select 
              value={selectedGroup}
              onChange={(e) => setSelectedGroup(e.target.value)}
              className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
            >
              {groups.map(g => <option key={g.id} value={g.id}>{g.name} (Semestr {g.semester})</option>)}
            </select>
          </div>

          {view === 'admin' && (
            <div className="bg-white p-5 rounded-2xl border shadow-sm space-y-4">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Boshqaruv</h3>
              <button onClick={() => setActiveTab('groups')} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${activeTab === 'groups' ? 'bg-blue-50 text-blue-700' : 'hover:bg-slate-50'}`}>
                <Users size={18} /> Guruhlar
              </button>
              <button onClick={() => setActiveTab('teachers')} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${activeTab === 'teachers' ? 'bg-blue-50 text-blue-700' : 'hover:bg-slate-50'}`}>
                <UserCheck size={18} /> O'qituvchilar
              </button>
              <button onClick={() => setActiveTab('subjects')} className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${activeTab === 'subjects' ? 'bg-blue-50 text-blue-700' : 'hover:bg-slate-50'}`}>
                <BookOpen size={18} /> Fanlar
              </button>
            </div>
          )}

          <div className="bg-blue-900 text-white p-6 rounded-2xl shadow-xl">
            <h4 className="font-bold mb-2 flex items-center gap-2 italic">
              <Info size={16} /> Ma'lumot
            </h4>
            <p className="text-xs text-blue-100 leading-relaxed">
              Tizim avtomatik ravishda amaliy darslarni (6 soat) blok ko'rinishida joylashtiradi. Konfliktlar qizil rangda belgilanadi.
            </p>
          </div>
        </div>

        {/* Main Schedule Canvas */}
        <div className="col-span-12 lg:col-span-9 bg-white rounded-2xl border shadow-sm overflow-hidden" id="printable-schedule">
          <div className="p-6 border-b flex justify-between items-center bg-slate-50/50">
            <div>
              <h2 className="text-2xl font-bold text-slate-800">Haftalik Dars Jadvali</h2>
              <p className="text-sm text-slate-500">Guruh: {groups.find(g => g.id === selectedGroup)?.name}</p>
            </div>
            <div className="flex gap-2">
               <div className="flex items-center gap-2 text-xs font-medium px-3 py-1 bg-green-100 text-green-700 rounded-full">
                 <div className="w-2 h-2 bg-green-500 rounded-full"></div> Optimal
               </div>
               <div className="flex items-center gap-2 text-xs font-medium px-3 py-1 bg-red-100 text-red-700 rounded-full">
                 <div className="w-2 h-2 bg-red-500 rounded-full"></div> Konflikt
               </div>
            </div>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr>
                  <th className="p-4 border bg-slate-50 text-xs font-bold text-slate-400 uppercase text-left w-24">Vaqt / Kun</th>
                  {DAYS.map(day => (
                    <th key={day} className="p-4 border bg-slate-50 text-sm font-bold text-slate-700 min-w-[160px]">
                      {day}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {SLOTS.map(slot => (
                  <tr key={slot.id}>
                    <td className="p-4 border bg-slate-50/30">
                      <div className="text-xs font-bold text-blue-600 mb-1">{slot.id}-PARA</div>
                      <div className="text-[10px] text-slate-400 font-mono">{slot.time}</div>
                    </td>
                    {DAYS.map(day => {
                      const lesson = getLesson(day, slot.id, selectedGroup);
                      const subj = lesson ? subjects.find(s => s.id === lesson.subjectId) : null;
                      const teacher = lesson ? teachers.find(t => t.id === lesson.teacherId) : null;

                      return (
                        <td key={day} className="p-2 border group relative align-top h-32">
                          {lesson ? (
                            <div 
                              className={`h-full w-full rounded-xl p-3 shadow-sm border-l-4 transition-all hover:scale-[1.02] cursor-pointer`}
                              style={{ 
                                backgroundColor: `${subj?.color}15`, 
                                borderColor: subj?.color || '#cbd5e1' 
                              }}
                            >
                              <div className="flex justify-between items-start mb-2">
                                <span 
                                  className="text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-tighter"
                                  style={{ backgroundColor: subj?.color, color: 'white' }}
                                >
                                  {lesson.type}
                                </span>
                                {view === 'admin' && <Trash2 size={12} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" />}
                              </div>
                              <h4 className="text-xs font-black text-slate-800 uppercase leading-tight mb-1">
                                {subj?.name}
                              </h4>
                              <p className="text-[11px] text-slate-600 font-medium">
                                {teacher?.lastName} {teacher?.firstName[0]}.
                              </p>
                              
                              {/* Tooltip on hover */}
                              <div className="absolute inset-0 bg-black/80 text-white p-3 rounded-xl opacity-0 group-hover:opacity-100 z-10 transition-opacity pointer-events-none flex flex-col justify-center text-center">
                                <p className="text-xs font-bold">{subj?.name}</p>
                                <p className="text-[10px] text-blue-300">{teacher?.lastName} {teacher?.firstName}</p>
                                <div className="mt-2 border-t border-white/20 pt-2 text-[9px] uppercase tracking-widest">Batafsil</div>
                              </div>
                            </div>
                          ) : (
                            <div className="h-full w-full border-2 border-dashed border-slate-100 rounded-xl flex items-center justify-center group-hover:bg-slate-50 transition-colors">
                              {view === 'admin' && <Plus size={16} className="text-slate-200 group-hover:text-blue-400" />}
                            </div>
                          )}
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          
          {/* PDF Footer for verification */}
          <div className="hidden print:block mt-12 px-8 py-10 border-t-2 border-slate-200">
             <div className="grid grid-cols-2 gap-20">
                <div className="space-y-4">
                   <h5 className="font-bold text-sm">TASDIQLAYMAN:</h5>
                   <div className="h-px bg-slate-400 w-48 mt-8"></div>
                   <p className="text-xs font-medium">O'quv ishlari bo'yicha prorektor</p>
                   <p className="text-xs">F.I.O: ________________________</p>
                </div>
                <div className="text-right space-y-2">
                   <p className="text-xs font-bold italic">ICHTU Axborot Tizimi</p>
                   <p className="text-[10px] text-slate-400">Yaratilgan sana: {new Date().toLocaleDateString()}</p>
                </div>
             </div>
          </div>
        </div>
      </main>

      {/* Floating Status Bar */}
      <div className="fixed bottom-6 right-6 flex items-center gap-3">
        {schedule.length > 0 && (
          <div className="bg-white border shadow-2xl rounded-2xl p-4 flex items-center gap-6 animate-in slide-in-from-bottom-4">
             <div className="flex items-center gap-2">
                <CheckCircle2 size={20} className="text-green-500" />
                <div>
                   <p className="text-[10px] font-bold text-slate-400 uppercase">Status</p>
                   <p className="text-xs font-bold">Xatosiz yaratildi</p>
                </div>
             </div>
             <div className="w-px h-8 bg-slate-100"></div>
             <div className="flex items-center gap-2 text-blue-600">
                <p className="text-xs font-black uppercase tracking-widest">Ver: 1.0.4</p>
             </div>
          </div>
        )}
      </div>

      <style>{`
        @media print {
          body { background: white; }
          .no-print, nav, .lg\\:col-span-3, .fixed { display: none !important; }
          .lg\\:col-span-9 { width: 100% !important; border: none !important; box-shadow: none !important; }
          table { width: 100% !important; border: 1px solid #eee; }
          .print\\:block { display: block !important; }
        }
      `}</style>
    </div>
  );
};

export default App;
