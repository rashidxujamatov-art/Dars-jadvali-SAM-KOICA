<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICHTU - Avtomatik Dars Jadvali</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .schedule-grid { display: grid; grid-template-columns: 100px repeat(6, 1fr); gap: 6px; }
        .slot-card { min-height: 90px; transition: all 0.2s; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-radius: 8px; padding: 4px; }
        .slot-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .conflict { background-color: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; }
        .normal { background-color: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; }
        .practical { background-color: #dcfce7; border: 1px solid #86efac; color: #15803d; }
        .empty-slot { background-color: #ffffff; border: 1px dashed #cbd5e1; color: #94a3b8; }
        .closed-day { background-color: #f1f5f9; border: 1px solid #e2e8f0; opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div id="app" class="max-w-[1600px] mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">ðŸ“˜ DARS JADVALI TIZIMI</h1>
                <p class="text-slate-500 text-sm font-medium">ICHTU â€¢ Avtomatik optimallashtirish va boshqaruv</p>
            </div>
            <div class="flex gap-3">
                <button onclick="generateSchedule()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">
                    ðŸ”„ Jadvalni Hisoblash
                </button>
                <button onclick="exportToPDF()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-slate-300 transition-all active:scale-95">
                    ðŸ“¥ PDF Eksport
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- Sidebar -->
            <aside class="xl:col-span-1 space-y-6">
                <!-- Ma'lumotlar Kiritish -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-800 mb-5 flex items-center gap-2 text-lg">
                        <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                        Ma'lumotlar Kiritish
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Guruh Nomi</label>
                            <input id="groupName" type="text" placeholder="Masalan: 211-Guruh" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">O'qituvchi (F.I.)</label>
                            <input id="teacherName" type="text" placeholder="Aliyev V." class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Fan va Hajmi (Soat)</label>
                            <div class="flex gap-2">
                                <input id="subjectName" type="text" placeholder="Fan nomi" class="flex-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                                <input id="subjectHours" type="number" placeholder="36" class="w-20 p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition text-center">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Turi</label>
                                <select id="subjectType" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                                    <option value="amaliy">Amaliy (6s)</option>
                                    <option value="nazariy">Nazariy (2s)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">Prioritet</label>
                                <input id="priority" type="number" value="1" min="1" max="10" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition text-center">
                            </div>
                        </div>
                        <button onclick="addData()" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl border border-indigo-200 transition-all active:scale-95 mt-2">
                            âž• Ro'yxatga Qo'shish
                        </button>
                    </div>
                </div>

                <!-- Fanlar Ro'yxati -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-800 mb-4 flex items-center justify-between">
                        Kiritilgan Fanlar
                        <span id="subjectCount" class="bg-slate-100 text-slate-600 text-[10px] px-2 py-1 rounded-full">0 ta</span>
                    </h2>
                    <div id="dataList" class="space-y-2 max-h-[400px] overflow-y-auto pr-1 custom-scrollbar">
                        <p class="text-slate-400 text-xs text-center py-8">Hozircha fanlar yo'q</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="xl:col-span-3 space-y-6">
                <!-- Kunlik Juftliklar Sozlamasi (Customizable) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-sm font-bold text-slate-700 mb-4 uppercase tracking-wider">Haftalik kunlar va maksimal juftliklar soni</h2>
                    <div id="daySettings" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <!-- JS orqali generatsiya qilinadi -->
                    </div>
                </div>

                <!-- Jadval Maydoni -->
                <div id="printableArea" class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 overflow-x-auto">
                    <!-- PDF Header (Hidden in Web) -->
                    <div id="pdfHeader" class="hidden mb-8">
                        <div class="flex justify-between items-start border-b-2 border-slate-900 pb-6">
                            <div class="w-1/3">
                                <p class="font-black text-sm">"TASDIQLAYMAN"</p>
                                <p class="text-[10px] text-slate-600 mt-1 uppercase">O'quv ishlari bo'yicha prorektor</p>
                                <div class="mt-8 border-b border-slate-400 w-48"></div>
                                <p class="text-[10px] mt-1 italic">F.I.O. _________________</p>
                            </div>
                            <div class="w-1/3 text-center">
                                <h2 class="text-3xl font-black text-slate-900 leading-none">ICHTU</h2>
                                <p class="text-xs font-bold mt-2 uppercase tracking-widest text-slate-500 italic">Oliy ta'lim muassasasi</p>
                                <div class="mt-4 inline-block bg-slate-900 text-white px-4 py-1 rounded text-[10px] font-bold">2024-2025 O'QUV YILI</div>
                            </div>
                            <div class="w-1/3 text-right">
                                <p class="text-[10px] font-bold uppercase text-slate-400">Hujjat raqami: #JAD-2024-001</p>
                                <p class="text-xs mt-2">Sana: <span id="currentDate" class="font-bold"></span></p>
                            </div>
                        </div>
                    </div>

                    <h2 id="scheduleTitle" class="text-center font-black text-2xl mb-6 text-slate-800 uppercase tracking-tight">
                        DARS JADVALI: <span id="activeGroupDisplay" class="text-indigo-600 underline decoration-indigo-200">---</span>
                    </h2>

                    <!-- Jadval Sarlavhasi -->
                    <div class="schedule-grid text-center font-black text-[11px] text-slate-400 uppercase tracking-widest mb-4">
                        <div class="py-2">Vaqt / Kun</div>
                        <div class="py-2 bg-slate-50 rounded-t-lg text-slate-600">Dushanba</div>
                        <div class="py-2 bg-slate-50 rounded-t-lg text-slate-600">Seshanba</div>
                        <div class="py-2 bg-slate-50 rounded-t-lg text-slate-600">Chorshanba</div>
                        <div class="py-2 bg-slate-50 rounded-t-lg text-slate-600">Payshanba</div>
                        <div class="py-2 bg-slate-50 rounded-t-lg text-slate-600">Juma</div>
                        <div class="py-2 bg-slate-50 rounded-t-lg text-slate-600">Shanba</div>
                    </div>

                    <div id="scheduleBody" class="space-y-1.5 min-w-[900px]">
                        <!-- JS orqali generatsiya qilinadi -->
                    </div>

                    <!-- PDF Footer (Hidden in Web) -->
                    <div id="pdfFooter" class="hidden mt-12 border-t-2 border-slate-100 pt-8">
                        <div class="grid grid-cols-2 gap-12">
                            <div>
                                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wider underline">Mas'ul o'qituvchilar</h3>
                                <ul id="teacherListFooter" class="text-[10px] space-y-2 text-slate-600 columns-2">
                                    <!-- Dinamik -->
                                </ul>
                            </div>
                            <div class="flex flex-col items-end justify-between">
                                <div class="text-right">
                                    <p class="text-sm font-bold text-slate-900">ICHTU O'QUV BO'LIMI</p>
                                    <p class="text-[9px] text-slate-500">Tizim orqali avtomatik shakllantirildi</p>
                                </div>
                                <div class="mt-8 text-center border-t border-slate-900 pt-2 w-48">
                                    <p class="text-[10px] font-bold uppercase">Bo'lim boshlig'i imzosi</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // State
        let appData = {
            subjects: [],
            schedule: {}, 
            groups: new Set(),
            teachers: new Set(),
            dayLimits: [8, 8, 8, 8, 8, 8] // Har kunlik default 4 juftlik (8 soat)
        };

        const DAYS = ['Dushanba', 'Seshanba', 'Chorshanba', 'Payshanba', 'Juma', 'Shanba'];
        const TIME_SLOTS = ["08:30 - 09:50", "10:00 - 11:20", "11:30 - 12:50", "13:30 - 14:50", "15:00 - 16:20"];

        // Init Day Settings UI
        function initDaySettings() {
            const container = document.getElementById('daySettings');
            container.innerHTML = DAYS.map((day, idx) => `
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 text-center">${day}</label>
                    <select onchange="updateDayLimit(${idx}, this.value)" class="w-full p-2 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="0">Yopiq</option>
                        <option value="2">1 Juftlik (2s)</option>
                        <option value="4">2 Juftlik (4s)</option>
                        <option value="6">3 Juftlik (6s)</option>
                        <option value="8" selected>4 Juftlik (8s)</option>
                        <option value="10">5 Juftlik (10s)</option>
                    </select>
                </div>
            `).join('');
        }

        function updateDayLimit(idx, val) {
            appData.dayLimits[idx] = parseInt(val);
        }

        function addData() {
            const group = document.getElementById('groupName').value.trim();
            const teacher = document.getElementById('teacherName').value.trim();
            const name = document.getElementById('subjectName').value.trim().toUpperCase();
            const hours = parseInt(document.getElementById('subjectHours').value);
            const type = document.getElementById('subjectType').value;
            const priority = parseInt(document.getElementById('priority').value);

            if (!group || !teacher || !name || isNaN(hours)) {
                alert("Iltimos, barcha ma'lumotlarni to'liq kiriting!");
                return;
            }

            const subjectObj = {
                id: Date.now(),
                group,
                teacher,
                name,
                totalHours: hours,
                remainingHours: hours,
                type,
                priority,
                color: type === 'amaliy' ? 'practical' : 'normal'
            };

            appData.subjects.push(subjectObj);
            appData.groups.add(group);
            appData.teachers.add(teacher);
            
            updateDataList();
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectHours').value = '';
            document.getElementById('subjectName').focus();
        }

        function updateDataList() {
            const list = document.getElementById('dataList');
            const count = document.getElementById('subjectCount');
            count.innerText = `${appData.subjects.length} ta`;

            if (appData.subjects.length === 0) {
                list.innerHTML = `<p class="text-slate-400 text-xs text-center py-8">Hozircha fanlar yo'q</p>`;
                return;
            }

            list.innerHTML = appData.subjects.map(s => `
                <div class="group relative bg-white p-3 rounded-xl border border-slate-100 hover:border-indigo-200 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start">
                        <div class="pr-6">
                            <span class="text-xs font-black text-slate-800 block leading-tight">${s.name}</span>
                            <div class="text-[10px] text-slate-500 mt-1">
                                <span class="bg-slate-100 px-1.5 py-0.5 rounded mr-1">${s.type.toUpperCase()}</span>
                                <span>${s.teacher}</span> â€¢ <span>${s.totalHours}s</span>
                            </div>
                        </div>
                        <button onclick="removeData(${s.id})" class="text-slate-300 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="absolute bottom-2 right-2 flex gap-1">
                         <span class="text-[9px] font-bold text-indigo-400">P:${s.priority}</span>
                    </div>
                </div>
            `).join('');
        }

        function removeData(id) {
            appData.subjects = appData.subjects.filter(s => s.id !== id);
            updateDataList();
        }

        function generateSchedule() {
            const groupList = Array.from(appData.groups);
            if (groupList.length === 0) {
                alert("Avval guruh va fanlarni qo'shing!");
                return;
            }

            const targetGroup = groupList[0]; // Soddalik uchun birinchi guruh
            document.getElementById('activeGroupDisplay').innerText = targetGroup;
            appData.schedule = {}; 

            // Algoritm: Priority va Type bo'yicha saralash
            const sortedSubjects = [...appData.subjects]
                .filter(s => s.group === targetGroup)
                .sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    if (a.type === 'amaliy' && b.type !== 'amaliy') return -1;
                    return 0;
                });

            sortedSubjects.forEach(s => s.remainingHours = s.totalHours);

            const teacherLoad = {}; 
            const lastDayTaught = {}; 

            for (let s of sortedSubjects) {
                const blockSize = s.type === 'amaliy' ? 6 : 2; 
                
                while (s.remainingHours >= blockSize) {
                    let placed = false;

                    for (let dayIdx = 0; dayIdx < 6; dayIdx++) {
                        if (placed) break;
                        const maxPairs = appData.dayLimits[dayIdx] / 2;
                        if (maxPairs === 0) continue;

                        if (s.type === 'amaliy' && lastDayTaught[s.id] === dayIdx - 1) continue;

                        const currentTeacherLoad = teacherLoad[`${s.teacher}_${dayIdx}`] || 0;
                        if (currentTeacherLoad + blockSize > 10) continue;

                        const slotsNeeded = blockSize / 2;

                        for (let slotIdx = 0; slotIdx <= maxPairs - slotsNeeded; slotIdx++) {
                            // Nazariy dars 1 yoki 4 juftlikka qo'yiladi (qoida bo'yicha)
                            if (s.type === 'nazariy' && slotIdx !== 0 && slotIdx !== 3) continue;

                            let canPlace = true;
                            for (let i = 0; i < slotsNeeded; i++) {
                                if (appData.schedule[`${dayIdx}_${slotIdx + i}`]) {
                                    canPlace = false;
                                    break;
                                }
                            }

                            if (canPlace) {
                                for (let i = 0; i < slotsNeeded; i++) {
                                    appData.schedule[`${dayIdx}_${slotIdx + i}`] = { ...s };
                                }
                                s.remainingHours -= blockSize;
                                teacherLoad[`${s.teacher}_${dayIdx}`] = currentTeacherLoad + blockSize;
                                lastDayTaught[s.id] = dayIdx;
                                placed = true;
                                break;
                            }
                        }
                    }
                    if (!placed) break; 
                }
            }
            renderSchedule();
        }

        function renderSchedule() {
            const body = document.getElementById('scheduleBody');
            body.innerHTML = '';

            for (let slotIdx = 0; slotIdx < 5; slotIdx++) {
                let rowHtml = `<div class="schedule-grid">
                    <div class="flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-xl p-2 shadow-inner">
                        <span class="text-[10px] font-black text-indigo-500">${slotIdx + 1}-JUFTLIK</span>
                        <span class="text-[9px] font-bold text-slate-400 mt-1">${TIME_SLOTS[slotIdx]}</span>
                    </div>`;
                
                for (let dayIdx = 0; dayIdx < 6; dayIdx++) {
                    const data = appData.schedule[`${dayIdx}_${slotIdx}`];
                    const isClosed = (appData.dayLimits[dayIdx] / 2) <= slotIdx;
                    
                    let cellClasses = "slot-card ";
                    if (isClosed) cellClasses += "closed-day";
                    else if (data) cellClasses += data.type === 'amaliy' ? "practical" : "normal";
                    else cellClasses += "empty-slot";

                    rowHtml += `
                        <div class="${cellClasses}" onclick="toggleCellState(${dayIdx}, ${slotIdx})">
                            ${data ? `
                                <div class="text-[10px] font-black uppercase tracking-tighter leading-none mb-1">${data.name}</div>
                                <div class="text-[9px] font-medium text-slate-500 truncate w-full px-1">${data.teacher}</div>
                                <div class="mt-1 bg-white/50 px-1.5 py-0.5 rounded text-[8px] font-bold uppercase">${data.type}</div>
                            ` : (isClosed ? '<span class="text-[8px] font-black opacity-30">YOPIQ</span>' : '')}
                        </div>
                    `;
                }
                rowHtml += `</div>`;
                body.innerHTML += rowHtml;
            }
        }

        function toggleCellState(day, slot) {
            const el = event.currentTarget;
            if (el.classList.contains('closed-day')) return;
            el.classList.toggle('conflict');
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const header = document.getElementById('pdfHeader');
            const footer = document.getElementById('pdfFooter');
            const currentDate = document.getElementById('currentDate');
            const teacherList = document.getElementById('teacherListFooter');

            currentDate.innerText = new Date().toLocaleDateString('uz-UZ');
            header.classList.remove('hidden');
            footer.classList.remove('hidden');
            
            teacherList.innerHTML = Array.from(appData.teachers).map(t => `<li>â€¢ ${t}</li>`).join('');

            const element = document.getElementById('printableArea');
            
            try {
                const canvas = await html2canvas(element, { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Jadval_${document.getElementById('activeGroupDisplay').innerText}.pdf`);
            } catch (err) {
                console.error("PDF generation error:", err);
            } finally {
                header.classList.add('hidden');
                footer.classList.add('hidden');
            }
        }

        // Init
        initDaySettings();
        renderSchedule();
    </script>
</body>
</html>
